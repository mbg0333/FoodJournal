import { GoogleGenerativeAI } from "@google/generative-ai"; const sleep = (ms) => new Promise(r => setTimeout(r, ms)); export const analyzeFood = async (key, input, type) => { if (!key) return null; const genAI = new GoogleGenerativeAI(key.trim()); const modelsToTry = ["gemini-2.0-flash", "gemini-1.5-flash"]; for (const modelName of modelsToTry) { for(let i=0; i<2; i++) { try { console.log("Checking " + modelName); const model = genAI.getGenerativeModel({ model: modelName, tools: [{ googleSearch: {} }] }); const prompt = "Find EXACT MACROS for: " + input + ". Return JSON {name, calories, protein, carbs, fat, category, serving_size}"; const payload = (type==="photo") ? [{text:prompt}, {inlineData:{data:input, mimeType:"image/jpeg"}}] : prompt; const res = await model.generateContent(payload); const txt = res.response.text(); const json = txt.match(/\{[\s\S]*\}/); if(json) return JSON.parse(json[0]); } catch(e) { console.warn(e); if(e.message.includes("429")) await sleep(5000); } } } return null; }


